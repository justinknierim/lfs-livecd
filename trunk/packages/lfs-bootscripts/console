#!/bin/sh
########################################################################
# Begin $rc_base/init.d/console
#
# Description : Sets keymap and screen font (LiveCD version)
#
# Authors     : Gerard Beekmans - gerard@linuxfromscratch.org
#		Alexander E. Patrakov
#
# Version     : 00.00-livecd
#
# Notes       : Unlike the stock "console" script, this version guesses
#               the correct font based on the user's locale.
#
########################################################################

. /etc/sysconfig/rc
. ${rc_functions}

# Native English speakers probably don't have /etc/sysconfig/console at all
if [ -f /etc/sysconfig/console ]; then
	. /etc/sysconfig/console
fi


guess_font() {
        CHARMAP=`locale charmap`

	FONTTABLE='
#Charset:FONT:ERROR_FLAG:CAVEAT
ANSI_X3.4-1968:default-8x16:0:You forgot to (correctly) set your locale!
BIG5:default-8x16:1:Chinese is not supported by this Live CD. Sorry.
BIG5-HKSCS:default-8x16:1:Chinese is not supported by this Live CD. Sorry.
CP1251:cyr-sun16 -m cp1251:0:
CP1255:LatArCyrHeb-16 -m 8859-8:0:The "kbd" package does not support CP1255 encoding, using ISO-8859-8 instead.
EUC-JP:default-8x16:1:Japanese is not supported by this Live CD. Sorry.
EUC-KR:default-8x16:1:Korean is not supported by this Live CD. Sorry.
EUC-TW:default-8x16:1:Chinese is not supported by this Live CD. Sorry.
GB18030:default-8x16:1:Chinese is not supported by this Live CD. Sorry.
GB2312:default-8x16:1:Chinese is not supported by this Live CD. Sorry.
GBK:default-8x16:1:Chinese is not supported by this Live CD. Sorry.
GEORGIAN-PS:default-8x16:1:Georgian is not supported by this Live CD. Sorry.
ISO-8859-1:lat1-16 -m 8859-1:0:
ISO-8859-2:lat2a-16 -m 8859-2:0:
#ISO-8859-3:iso03.16 -m 8859-3:0:Line drawing characters are not available with this font.
ISO-8859-3:LatArCyrHeb-16 -m 8859-3:0:Bright colors are not available with this font.
#ISO-8859-5:iso05.16 -m 8859-5:0:Line drawing characters are not available with this font.
ISO-8859-5:LatArCyrHeb-16 -m 8859-5:0:Bright colors are not available with this font.
#ISO-8859-6:iso06.16 -m 8859-6:0:Line drawing characters are not available with this font.
ISO-8859-6:LatArCyrHeb-16 -m 8859-6:0:Bright colors are not available with this font.
ISO-8859-7:iso07u-16 -m 8859-7:0:
ISO-8859-8:LatArCyrHeb-16 -m 8859-8:0:Bright colors are not available with this font.
ISO-8859-9:cp857.16 -u /usr/share/kbd/consoletrans/cp857_to_uni.trans -m 8859-9:0:
#ISO-8859-10:iso10.16 -m 8859-10:0:Line drawing characters are not available with this font.
ISO-8859-10:LatArCyrHeb-16 -m 8859-10:0:Bright colors are not available with this font.
#ISO-8859-13:lat7-14 -m 8859-13:0:Line drawing characters are not available with this font.
ISO-8859-13:LatArCyrHeb-16 -m 8859-13:0:Bright colors are not available with this font.
ISO-8859-14:default-8x16:1:Welsh is not supported by this Live CD. Sorry.
ISO-8859-15:lat0-16 -m 8859-15:0:
#KOI8-R:koi8r-8x16 -u koi8r -m koi8-r:0:This font is ugly.
KOI8-R:cyr-sun16 -m koi8-r:0:
KOI8-T:cyr-sun16 -m koi8-r:0:The "kbd" package does not support KOI8-T encoding, using KOI8-R instead.
KOI8-U:cyr-sun16 -m koi8-u:0:
PT154:cyr-sun16 -m cp1251:0:The "kbd" package does not support PT154 encoding, using CP1251 instead.
TCVN5712-1:default-8x16:1:Vietnamese is not supported by this Live CD. Sorry.
TIS-620:default-8x16:1:Thai is not supported by this Live CD. Sorry.
UTF-8:LatArCyrHeb-16:0:\033%GThis Live CD does not officially support UTF-8.
'

	FONTLINE=`echo "$FONTTABLE" | egrep "^$CHARMAP:"`
	FONT=`echo "$FONTLINE" | cut -d ":" -f 2`
	ERROR=`echo "$FONTLINE" | cut -d ":" -f 3`
	FONT_PROBLEM=`echo "$FONTLINE" | cut -d ":" -f 4`

	return $ERROR
}

case "${1}" in
	start)
		if [ -n "${KEYMAP}" ]; then
			boot_mesg "Loading keymap: ${KEYMAP}..."
			loadkeys ${KEYMAP} &>/dev/null
			evaluate_retval
		fi

		if [ -n "${KEYMAP_CORRECTIONS}" ]; then
			boot_mesg "Loading keymap corrections: ${KEYMAP_CORRECTIONS}..."
			loadkeys ${KEYMAP_CORRECTIONS} &>/dev/null
			evaluate_retval
		fi

		if [ -n "${FONT}" ]; then
			boot_mesg "Setting screen font to ${FONT}..."
			setfont $FONT &>/dev/null
			evaluate_retval
		else
			guess_font
			boot_mesg "Setting screen font to ${FONT}..."
			boot_mesg_flush
			setfont $FONT &>/dev/null
			if [ ! -z "$FONT_PROBLEM" ] ; then
				boot_mesg "WARNING:\n${FONT_PROBLEM}" ${WARNING}
				boot_mesg_flush
			fi
			( exit $ERROR )
			evaluate_retval
		fi
		;;
	*)
		echo "Usage: ${0} {start}"
		exit 1
		;;
esac

# End $rc_base/init.d/console
